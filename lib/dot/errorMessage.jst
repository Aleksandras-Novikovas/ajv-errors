{{# def.definitions }}
{{# def.errors }}
{{# def.setupKeyword }}

{{## def.em_errorMatch:
  {{=$err}}.keyword != '{{=$keyword}}'
  && ({{=$err}}.dataPath == {{=$dataPath}} ||
      ({{=$err}}.dataPath.indexOf({{=$dataPath}}) == 0 &&
       {{=$err}}.dataPath[{{=$dataPath}}.length] == '/'))
  && {{=$err}}.schemaPath.indexOf({{=$errSchemaPathString}}) == 0
  && {{=$err}}.schemaPath[{{=it.errSchemaPath.length}}] == '/'
#}}

{{## def.em_keywordErrorMatch:
  {{=$err}}.keyword in {{=$errors}}
  && {{=$err}}.dataPath == {{=$dataPath}}
  && {{=$err}}.schemaPath.indexOf({{=$errSchemaPathString}}) == 0
  && /^\/[^\/]*$/.test({{=$err}}.schemaPath.slice({{=it.errSchemaPath.length}}))
#}}

{{## def.em_childErrorMatch:
  {{=$err}}.keyword != '{{=$keyword}}'
  && {{=$err}}.dataPath.indexOf({{=$dataPath}}) == 0
  && ({{=$matches}} = {{=$err}}.dataPath.slice({{=$dataPath}}.length).match(/^\/([^\/]*)(?:\/|$)/),
      {{=$child}} = {{=$matches}} && {{=$matches}}[1].replace(/~1/g, '/').replace(/~0/g, '~')
     ) !== undefined
  && {{=$child}} in {{=$errors}}
#}}

{{## def.compileTemplates: _keysArray:
  var {{=$templates}} = {
    {{ var $comma = false; }}
    {{~ _keysArray:$k }}
      {{? INTERPOLATION.test($schema[$k]) }}
        {{?$comma}},{{?}}{{= it.util.toQuotedString($k) }}: {{= templateFunc($schema[$k]) }}
        {{ $comma = true; }}
      {{?}}
    {{~}}
  };
#}}

{{## def.compileChildTemplates: _children:
  {{ var __keys = Object.keys($childErrors._children); }}
  {{# def.compileTemplates:__keys }}
#}}


{{? it.createErrors !== false }}
  {{
    var INTERPOLATION = /\$\{([^\}]+)\}/g;
    var EMPTY_STR = /^\'\'\s*\+\s*|\s*\+\s*\'\'$/g;

    var $config = it.self.getKeyword($keyword).config
      , $dataPath = '_em_dataPath' + $lvl
      , $i = '_em_i' + $lvl
      , $key = '_em_key' + $lvl
      , $err = '_em_err' + $lvl
      , $child = '_em_child' + $lvl
      , $childKeyword = '_em_childKeyword' + $lvl
      , $matches = '_em_matches' + $lvl
      , $isArray = '_em_isArray' + $lvl
      , $errors = '_em_errors' + $lvl
      , $templates = '_em_templates' + $lvl
      , $errSchemaPathString = it.util.toQuotedString(it.errSchemaPath);
  }}

  if (errors > 0) {
    var {{=$dataPath}} = (dataPath || '') + {{= it.errorPath }};
    var {{=$i}}, {{=$err}}, {{=$errors}};


    {{? typeof $schema == 'string' }}
      {{=$i}} = 0;
      {{=$errors}} = [];
      while ({{=$i}} < errors) {
        {{=$err}} = vErrors[{{=$i}}];
        if ({{# def.em_errorMatch}}) {
          {{=$errors}}.push({{=$err}});
          vErrors.splice({{=$i}}, 1);
          errors--;
        } else {
          {{=$i}}++;
        }
      }
      if ({{=$errors}}.length) {
        var err = {
          keyword: '{{=$keyword}}'
          , dataPath: {{=$dataPath}}
          , schemaPath: {{=$errSchemaPathString}} + '/{{=$keyword}}'
          , params: { errors: {{=$errors}} }
          , message: {{=templateExpr($schema)}}
          {{? it.opts.verbose }}
            , schema: {{=it.util.toQuotedString($schema)}}
            , parentSchema: validate.schema{{=it.schemaPath}}
            , data: {{=$data}}
          {{?}}
        };
        {{# def._addError:'custom' }}
      }
    {{??}}
      {{
        var $keywordErrors = {}
          , $childErrors = { properties: {}, items: {} }
          , $hasProperties, $hasItems;

        for (var $k in $schema) {
          switch ($k) {
            case 'properties':
              for (var $prop in $schema.properties) {
                $hasProperties = true;
                $childErrors.properties[$prop] = [];
              }
              break;
            case 'items':
              for (var $item=0; $item<$schema.items.length; $item++) {
                $hasItems = true;
                $childErrors.items[$item] = [];
              }
              break;
            default:
              $keywordErrors[$k] = [];
          }
        }
      }}

      {{ var $keywordErrorsArr = Object.keys($keywordErrors); }}
      {{? $keywordErrorsArr.length }}
        {{=$i}} = 0;
        {{=$errors}} = {{= JSON.stringify($keywordErrors) }};
        {{# def.compileTemplates:$keywordErrorsArr }}
        while ({{=$i}} < errors) {
          {{=$err}} = vErrors[{{=$i}}];
          if ({{# def.em_keywordErrorMatch}}) {
            {{=$errors}}[{{=$err}}.keyword].push({{=$err}});
            vErrors.splice({{=$i}}, 1);
            errors--;
          } else {
            {{=$i}}++;
          }
        }
        for (var {{=$key}} in {{=$errors}}) {
          if ({{=$errors}}[{{=$key}}].length) {
            var err = {
              keyword: '{{=$keyword}}'
              , dataPath: {{=$dataPath}}
              , schemaPath: {{=$errSchemaPathString}} + '/{{=$keyword}}'
              , params: { errors: {{=$errors}}[{{=$key}}] }
              , message: {{=$key}} in {{=$templates}}
                          ? {{=$templates}}[{{=$key}}] ()
                          : validate.schema{{=$schemaPath}}[{{=$key}}]
              {{? it.opts.verbose }}
                , schema: validate.schema{{=$schemaPath}}
                , parentSchema: validate.schema{{=it.schemaPath}}
                , data: {{=$data}}
              {{?}}
            };
            {{# def._addError:'custom' }}
          }
        }
      {{?}}

      {{? $hasProperties || $hasItems }}
        var {{=$isArray}} = Array.isArray({{=$data}});
        if
          {{? $hasProperties && $hasItems }}
            (typeof {{=$data}} == 'object') {
              {{ var $childProp = '[' + $childKeyword + ']'; }}
              {{=$i}} = 0;
              if ({{=$isArray}}) {
                var {{=$childKeyword}} = 'items';
                {{=$errors}} = {{= JSON.stringify($childErrors.items) }}; 
                {{# def.compileChildTemplates: items }}
              } else {
                var {{=$childKeyword}} = 'properties';
                {{=$errors}} =  {{= JSON.stringify($childErrors.properties) }}; 
                {{# def.compileChildTemplates: properties }}
              }
          {{?? $hasProperties }}
            (typeof {{=$data}} == 'object' && !{{=$isArray}}) {
              {{ var $childProp = '.properties'; }}
              {{=$i}} = 0;
              {{=$errors}} = {{= JSON.stringify($childErrors.properties) }};
              {{# def.compileChildTemplates: properties }}
          {{??}}
            ({{=$isArray}}) {
              {{ var $childProp = '.items'; }}
              {{=$i}} = 0;
              {{=$errors}} = {{= JSON.stringify($childErrors.items) }};
              {{# def.compileChildTemplates: items }}
          {{?}}

          var {{=$child}}, {{=$matches}};
          while ({{=$i}} < errors) {
            {{=$err}} = vErrors[{{=$i}}];
            if ({{# def.em_childErrorMatch}}) {
              {{=$errors}}[{{=$child}}].push({{=$err}});
              vErrors.splice({{=$i}}, 1);
              errors--;
            } else {
              {{=$i}}++;
            }
          }
          for (var {{=$key}} in {{=$errors}}) {
            if ({{=$errors}}[{{=$key}}].length) {
              var err = {
                keyword: '{{=$keyword}}'
                , dataPath: {{=$dataPath}} + '/' + {{=$key}}.replace(/~/g, '~0').replace(/\//g, '~1')
                , schemaPath: {{=$errSchemaPathString}} + '/{{=$keyword}}'
                , params: { errors: {{=$errors}}[{{=$key}}] }
                , message: {{=$key}} in {{=$templates}}
                            ? {{=$templates}}[{{=$key}}] ()
                            : validate.schema{{=$schemaPath}}{{=$childProp}}[{{=$key}}]
                {{? it.opts.verbose }}
                  , schema: validate.schema{{=$schemaPath}}
                  , parentSchema: validate.schema{{=it.schemaPath}}
                  , data: {{=$data}}
                {{?}}
              };
              {{# def._addError:'custom' }}
            }
          } /* for */
        } /* if */
      {{?}}
    {{?}}
  }
{{?}}


{{
  function templateExpr(str) {
    str = it.util.escapeQuotes(str);
    if (!INTERPOLATION.test(str)) return "'" + str + "'";
    var expr = "'" + str.replace(INTERPOLATION, function ($0, $1) {
      return "' + JSON.stringify(" + it.util.getData($1, $dataLvl, it.dataPathArr) + ") + '";
    }) + "'";
    return expr.replace(EMPTY_STR, '');
  }

  function templateFunc(str) {
    return 'function() { return ' + templateExpr(str) + '; }';
  }
}}
